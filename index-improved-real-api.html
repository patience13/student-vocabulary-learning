<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å„¿ç«¥è¯†å­—å°æŠ¥ç”Ÿæˆå™¨</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* åœºæ™¯é€‰æ‹©æ ·å¼ */
        .scene-selection {
            margin: 2rem 0;
            padding: 1.5rem;
            background-color: #F5F5F5;
            border-radius: 8px;
        }
        .scene-selection h3 {
            margin-bottom: 1rem;
            color: #333;
        }
        .scene-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.75rem;
        }
        .scene-card {
            padding: 1rem;
            background-color: white;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        .scene-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        .scene-card.selected {
            border-color: var(--primary-color);
            background-color: #E8F5E9;
        }
        .scene-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        .scene-name {
            font-weight: bold;
            color: #333;
            font-size: 0.95rem;
        }
        .custom-scene-btn {
            border-style: dashed;
            color: var(--secondary-color);
        }
        /* è‡ªå®šä¹‰ä¸»é¢˜è¾“å…¥ */
        .custom-theme-input {
            margin: 1rem 0;
        }
        .custom-theme-input input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
        }
        .custom-theme-input input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        /* è‡ªå®šä¹‰åœºæ™¯è¾“å…¥æ¡†æ ·å¼ */
        .custom-scene-container {
            margin: 2rem 0;
        }
        .custom-scene-input .input-group {
            position: relative;
            max-width: 500px;
            margin: 0 auto;
        }
        .input-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
            font-size: 1.2rem;
            z-index: 1;
        }
        .custom-scene-input input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border: 2px solid #E0E0E0;
            border-radius: 10px;
            font-size: 1rem;
            background-color: #FAFAFA;
            transition: all 0.3s ease;
        }
        .custom-scene-input input:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: white;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        .input-line {
            position: absolute;
            bottom: 0;
            left: 3rem;
            right: 0;
            height: 2px;
            background-color: var(--primary-color);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        .custom-scene-input input:focus + .input-line {
            transform: scaleX(1);
        }
        /* è¿›åº¦æç¤ºä¼˜åŒ– */
        #progressText {
            margin-top: 1rem;
            font-size: 0.95rem;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-book-open"></i>
                    <span>å„¿ç«¥è¯†å­—å°æŠ¥ç”Ÿæˆå™¨</span>
                </div>
                <div class="header-actions">
                    <button id="settingsBtn" class="btn btn-secondary">
                        <i class="fas fa-cog"></i> APIè®¾ç½®
                    </button>
                </div>
            </div>
        </header>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <!-- å¯¹è¯åŒºåŸŸ -->
            <section class="dialog-section">
                <div class="dialog-container">
                    <div id="dialogBox" class="dialog-box">
                        <div class="message system-message">
                            <div class="message-content">
                                <p>æ¬¢è¿ä½¿ç”¨å„¿ç«¥è¯†å­—å°æŠ¥ç”Ÿæˆå™¨ï¼</p>
                                <p>æˆ‘å°†å¸®åŠ©æ‚¨åˆ›å»ºé€‚åˆ5-9å²å„¿ç«¥çš„è¯†å­—å­¦ä¹ å°æŠ¥ã€‚</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ä¸»é¢˜é€‰æ‹©åŒºåŸŸ -->
            <section id="themeSelector" class="theme-selector" style="display: block;">
                <h3>ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©ä¸€ä¸ªä¸»é¢˜æˆ–è‡ªå®šä¹‰ä¸»é¢˜</h3>
                <div class="theme-grid">
                    <div class="theme-card" data-theme="supermarket">
                        <div class="theme-icon">ğŸ›’</div>
                        <div class="theme-name">è¶…å¸‚</div>
                    </div>
                    <div class="theme-card" data-theme="hospital">
                        <div class="theme-icon">ğŸ¥</div>
                        <div class="theme-name">åŒ»é™¢</div>
                    </div>
                    <div class="theme-card" data-theme="park">
                        <div class="theme-icon">ğŸŒ³</div>
                        <div class="theme-name">å…¬å›­</div>
                    </div>
                    <div class="theme-card" data-theme="school">
                        <div class="theme-icon">ğŸ«</div>
                        <div class="theme-name">å­¦æ ¡</div>
                    </div>
                    <div class="theme-card" data-theme="zoo">
                        <div class="theme-icon">ğŸ¦</div>
                        <div class="theme-name">åŠ¨ç‰©å›­</div>
                    </div>
                    <div class="theme-card" data-theme="traffic">
                        <div class="theme-icon">ğŸš¦</div>
                        <div class="theme-name">äº¤é€š</div>
                    </div>
                    <div class="theme-card" data-theme="home">
                        <div class="theme-icon">ğŸ </div>
                        <div class="theme-name">å®¶åº­</div>
                    </div>
                    <div class="theme-card" data-theme="farm">
                        <div class="theme-icon">ğŸšœ</div>
                        <div class="theme-name">å†œåœº</div>
                    </div>
                    <div class="theme-card theme-custom" data-theme="custom">
                        <div class="theme-icon">âœï¸</div>
                        <div class="theme-name">è‡ªå®šä¹‰ä¸»é¢˜</div>
                    </div>
                </div>
            </section>

            <!-- åœºæ™¯é€‰æ‹©åŒºåŸŸ -->
            <section id="sceneSelector" class="theme-selector" style="display: none;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                    <h3 style="margin: 0;">ç¬¬äºŒæ­¥ï¼šé€‰æ‹©ä¸€ä¸ªåœºæ™¯</h3>
                    <button id="backToThemeBtn" class="btn btn-secondary" style="display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-arrow-left"></i>
                        è¿”å›ä¸»é¢˜é€‰æ‹©
                    </button>
                </div>
                <div id="sceneGrid" class="scene-grid">
                    <!-- åŠ¨æ€ç”Ÿæˆåœºæ™¯å¡ç‰‡ -->
                </div>
                <div id="customSceneContainer" class="custom-scene-container" style="display: none; margin-top: 2rem;">
                    <div class="custom-scene-input">
                        <div class="input-group">
                            <div class="input-icon">
                                <i class="fas fa-pen"></i>
                            </div>
                            <input type="text" id="customSceneInput" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰åœºæ™¯åç§°" maxlength="50">
                            <div class="input-line"></div>
                        </div>
                    </div>
                </div>
                <button id="startGenerationBtn" class="btn btn-primary" style="margin-top: 2rem; display: block; margin-left: auto; margin-right: auto;" disabled>
                    <i class="fas fa-magic"></i>
                    å¼€å§‹ç”Ÿæˆå°æŠ¥
                </button>
            </section>

            <!-- ç”Ÿæˆé¢„è§ˆåŒº -->
            <section id="previewSection" class="preview-section" style="display: none;">
                <div class="preview-container">
                    <h3>ç”Ÿæˆçš„å°æŠ¥</h3>
                    <div id="imageViewer" class="image-viewer">
                        <!-- ç”Ÿæˆè¿›åº¦ -->
                        <div id="generationProgress" class="generation-progress" style="display: none;">
                            <div class="progress-content">
                                <div class="spinner"></div>
                                <p id="progressText">æ­£åœ¨ç”Ÿæˆå°æŠ¥ï¼Œè¯·ç¨å€™...</p>
                                <div class="progress-bar">
                                    <div class="progress-fill"></div>
                                </div>
                            </div>
                        </div>

                        <!-- å›¾ç‰‡å±•ç¤º -->
                        <div id="imageResult" class="image-result" style="display: none;">
                            <img id="generatedImage" src="" alt="ç”Ÿæˆçš„å°æŠ¥">
                            <div class="image-actions">
                                <button id="downloadBtn" class="btn btn-success">
                                    <i class="fas fa-download"></i> ä¸‹è½½å›¾ç‰‡
                                </button>
                                <button id="regenerateBtn" class="btn btn-secondary">
                                    <i class="fas fa-redo"></i> é‡æ–°ç”Ÿæˆ
                                </button>
                                <button id="newCreateBtn" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> åˆ›å»ºæ–°çš„å°æŠ¥
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- APIè®¾ç½®æ¨¡æ€æ¡† -->
        <div id="settingsModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>APIè®¾ç½®</h2>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="apiKeyInput">API Key:</label>
                        <input type="password" id="apiKeyInput" placeholder="è¯·è¾“å…¥æ‚¨çš„Kie AI API Key">
                        <small>è·å–API Key: <a href="https://kie.ai/api-key" target="_blank">https://kie.ai/api-key</a></small>
                    </div>
                    <div class="form-group">
                        <label for="resolutionSelect">åˆ†è¾¨ç‡:</label>
                        <select id="resolutionSelect">
                            <option value="2K">2K (æ¨è)</option>
                            <option value="4K">4K (æ›´æ¸…æ™°)</option>
                            <option value="1K">1K</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="formatSelect">è¾“å‡ºæ ¼å¼:</label>
                        <select id="formatSelect">
                            <option value="png">PNG</option>
                            <option value="jpg">JPG</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="saveSettingsBtn" class="btn btn-primary">ä¿å­˜è®¾ç½®</button>
                    <button id="cancelSettingsBtn" class="btn btn-secondary">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('å¼€å§‹åŠ è½½çœŸå®APIç‰ˆåº”ç”¨...');

        // åœºæ™¯æ•°æ®åº“
        const sceneData = {
            'supermarket': [
                { name: 'è¶…å¸‚æ¢é™©è®°', icon: 'ğŸ—ºï¸', desc: 'æ¢ç´¢è¶…å¸‚çš„å„ä¸ªè§’è½' },
                { name: 'è´­ç‰©å°è¾¾äºº', icon: 'ğŸ›ï¸', desc: 'å­¦ä¹ å¦‚ä½•èªæ˜è´­ç‰©' },
                { name: 'è¶…å¸‚é‡Œçš„ç¾é£Ÿ', icon: 'ğŸ', desc: 'è®¤è¯†å„ç§é£Ÿç‰©' },
                { name: 'æ”¶é“¶å°çš„ç§˜å¯†', icon: 'ğŸ’°', desc: 'äº†è§£æ”¶é“¶å’Œä»˜æ¬¾' },
                { name: 'è¶…å¸‚èŒä¸šä½“éªŒ', icon: 'ğŸ‘”', desc: 'ä½“éªŒè¶…å¸‚å·¥ä½œäººå‘˜çš„ä¸€å¤©' },
                { name: 'è¶…å¸‚å®‰å…¨å®ˆåˆ™', icon: 'âš ï¸', desc: 'å­¦ä¹ è¶…å¸‚å®‰å…¨çŸ¥è¯†' }
            ],
            'hospital': [
                { name: 'åŒ»ç”ŸæŠ¤å£«çš„ä¸€å¤©', icon: 'ğŸ‘¨â€âš•ï¸', desc: 'äº†è§£åŒ»æŠ¤äººå‘˜çš„å·¥ä½œ' },
                { name: 'å¥åº·å°å«å£«', icon: 'ğŸ›¡ï¸', desc: 'å­¦ä¹ ä¿æŒå¥åº·çš„æ–¹æ³•' },
                { name: 'åŒ»é™¢å¤§æ¢ç§˜', icon: 'ğŸ¥', desc: 'å‚è§‚åŒ»é™¢çš„å„ä¸ªç§‘å®¤' },
                { name: 'çœ‹ç—…ä¸å®³æ€•', icon: 'ğŸ˜Š', desc: 'å…‹æœçœ‹åŒ»é™¢çš„ææƒ§' },
                { name: 'æ€¥æ•‘å°çŸ¥è¯†', icon: 'ğŸš‘', desc: 'å­¦ä¹ åŸºæœ¬çš„æ€¥æ•‘å¸¸è¯†' },
                { name: 'ç¥å¥‡çš„äººä½“', icon: 'ğŸ§', desc: 'äº†è§£äººä½“çš„å¥¥ç§˜' }
            ],
            'park': [
                { name: 'å…¬å›­é‡Œçš„å››å­£', icon: 'ğŸŒ¸', desc: 'æ„Ÿå—å…¬å›­çš„å››å­£å˜åŒ–' },
                { name: 'èŠ±è‰æ ‘æœ¨æœ‹å‹', icon: 'ğŸŒ¿', desc: 'è®¤è¯†å…¬å›­çš„æ¤ç‰©' },
                { name: 'å…¬å›­æ¸¸ä¹åœº', icon: 'ğŸ ', desc: 'äº«å—æ¸¸ä¹è®¾æ–½' },
                { name: 'å…¬å›­è¿åŠ¨å¥å°†', icon: 'ğŸƒ', desc: 'åœ¨å…¬å›­åšè¿åŠ¨' },
                { name: 'é‡é¤æ—¶å…‰', icon: 'ğŸ§º', desc: 'å…¬å›­é‡é¤çš„ä¹è¶£' },
                { name: 'ç¯ä¿å°å«å£«', icon: 'â™»ï¸', desc: 'ä¿æŠ¤å…¬å›­ç¯å¢ƒ' }
            ],
            'school': [
                { name: 'å¿«ä¹ä¸Šå­¦å»', icon: 'ğŸ’', desc: 'ä½“éªŒä¸Šå­¦çš„å¿«ä¹' },
                { name: 'è¯¾å ‚å­¦ä¹ è®°', icon: 'âœï¸', desc: 'è¯¾å ‚ä¸Šçš„å­¦ä¹ ç”Ÿæ´»' },
                { name: 'è¯¾é—´ååˆ†é’Ÿ', icon: 'â°', desc: 'è¯¾é—´æ´»åŠ¨çš„ä¹è¶£' },
                { name: 'å›¾ä¹¦é¦†æ¢é™©', icon: 'ğŸ“š', desc: 'åœ¨å›¾ä¹¦é¦†å‘ç°æ–°çŸ¥è¯†' },
                { name: 'è¿åŠ¨ä¼šä¸Šçš„è‹±é›„', icon: 'ğŸ†', desc: 'å‚åŠ è¿åŠ¨ä¼š' },
                { name: 'ç§‘æŠ€å°å‘æ˜', icon: 'ğŸ’¡', desc: 'å±•ç¤ºç§‘å­¦å°å‘æ˜' }
            ],
            'zoo': [
                { name: 'åŠ¨ç‰©ä¸–ç•Œå¤§å†’é™©', icon: 'ğŸ¦', desc: 'è®¤è¯†å„ç§åŠ¨ç‰©' },
                { name: 'åŠ¨ç‰©çš„å®¶', icon: 'ğŸ ', desc: 'äº†è§£åŠ¨ç‰©çš„æ –æ¯åœ°' },
                { name: 'åŠ¨ç‰©å¥½æœ‹å‹', icon: 'ğŸ˜', desc: 'å’ŒåŠ¨ç‰©äº¤æœ‹å‹' },
                { name: 'é¥²å…»å‘˜å”å”é˜¿å§¨', icon: 'ğŸ‘©â€ğŸŒ¾', desc: 'äº†è§£é¥²å…»å‘˜çš„å·¥ä½œ' },
                { name: 'ä¿æŠ¤çç¨€åŠ¨ç‰©', icon: 'ğŸ¦', desc: 'å­¦ä¹ ä¿æŠ¤æ¿’å±åŠ¨ç‰©' },
                { name: 'åŠ¨ç‰©è¡¨æ¼”ç§€', icon: 'ğŸª', desc: 'è§‚çœ‹ç²¾å½©çš„åŠ¨ç‰©è¡¨æ¼”' }
            ],
            'traffic': [
                { name: 'äº¤é€šå®‰å…¨å°å«å£«', icon: 'ğŸš¦', desc: 'å­¦ä¹ äº¤é€šè§„åˆ™' },
                { name: 'å„ç§å„æ ·çš„è½¦', icon: 'ğŸš—', desc: 'è®¤è¯†ä¸åŒçš„äº¤é€šå·¥å…·' },
                { name: 'é©¬è·¯ä¸Šçš„æ•…äº‹', icon: 'ğŸ›£ï¸', desc: 'é©¬è·¯ä¸Šçš„äº¤é€šå®‰å…¨' },
                { name: 'å°å°é©¾é©¶å‘˜', icon: 'ğŸšŒ', desc: 'ä½“éªŒé©¾é©¶çš„ä¹è¶£' },
                { name: 'äº¤é€šè­¦å¯Ÿçš„ä¸€å¤©', icon: 'ğŸ‘®', desc: 'äº†è§£äº¤è­¦çš„å·¥ä½œ' },
                { name: 'æœªæ¥äº¤é€šå·¥å…·', icon: 'ğŸš€', desc: 'æƒ³è±¡æœªæ¥çš„äº¤é€š' }
            ],
            'home': [
                { name: 'æˆ‘çš„å®¶', icon: 'ğŸ¡', desc: 'ä»‹ç»æˆ‘çš„å®¶åº­æˆå‘˜' },
                { name: 'å®¶åŠ¡å°å¸®æ‰‹', icon: 'ğŸ§¹', desc: 'å­¦ä¹ åšå®¶åŠ¡' },
                { name: 'æ¸©é¦¨çš„æ™šé¤', icon: 'ğŸ½ï¸', desc: 'å®¶åº­èšé¤çš„æ—¶å…‰' },
                { name: 'å‘¨æœ«å®¶åº­æ—¥', icon: 'ğŸª', desc: 'å‘¨æœ«å®¶åº­æ´»åŠ¨' },
                { name: 'å®¶é‡Œçš„å®‰å…¨', icon: 'ğŸ”', desc: 'å®¶åº­å®‰å…¨çŸ¥è¯†' },
                { name: 'æˆ‘çˆ±æˆ‘å®¶', icon: 'â¤ï¸', desc: 'è¡¨è¾¾å¯¹å®¶äººçš„çˆ±' }
            ],
            'farm': [
                { name: 'å†œåœºä¸€æ—¥æ¸¸', icon: 'ğŸŒ¾', desc: 'å‚è§‚å†œåœºä½“éªŒç”Ÿæ´»' },
                { name: 'å†œä½œç‰©æˆé•¿è®°', icon: 'ğŸŒ±', desc: 'äº†è§£æ¤ç‰©çš„ç”Ÿé•¿' },
                { name: 'å†œåœºåŠ¨ç‰©æœ‹å‹', icon: 'ğŸ„', desc: 'è®¤è¯†å†œåœºåŠ¨ç‰©' },
                { name: 'ä¸°æ”¶çš„å­£èŠ‚', icon: 'ğŸŠ', desc: 'ä½“éªŒæ”¶è·çš„å–œæ‚¦' },
                { name: 'å†œè€•å·¥å…·å¤§å…¨', icon: 'ğŸ”¨', desc: 'è®¤è¯†å„ç§å†œå…·' },
                { name: 'å†œå¤«çš„è¾›å‹¤', icon: 'ğŸ‘¨â€ğŸŒ¾', desc: 'äº†è§£å†œæ°‘çš„è¾›è‹¦' }
            ]
        };

        // å…¨å±€å˜é‡
        let selectedTheme = null;
        let selectedScene = null;
        let customThemeName = null;
        let customSceneName = null;

        // DOMå…ƒç´ 
        const themeCards = document.querySelectorAll('.theme-card');
        const themeSelector = document.getElementById('themeSelector');
        const sceneSelector = document.getElementById('sceneSelector');
        const sceneGrid = document.getElementById('sceneGrid');
        const startGenerationBtn = document.getElementById('startGenerationBtn');
        const dialogBox = document.getElementById('dialogBox');
        const previewSection = document.getElementById('previewSection');

        // ä¸»é¢˜é€‰æ‹©
        themeCards.forEach(card => {
            card.addEventListener('click', function() {
                themeCards.forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                selectedTheme = this.dataset.theme;

                if (selectedTheme === 'custom') {
                    showCustomThemeInput();
                } else {
                    showSceneSelection(selectedTheme);
                }
            });
        });

        // æ˜¾ç¤ºè‡ªå®šä¹‰ä¸»é¢˜è¾“å…¥
        function showCustomThemeInput() {
            themeSelector.innerHTML = `
                <h3>è¯·è¾“å…¥è‡ªå®šä¹‰ä¸»é¢˜åç§°</h3>
                <div class="custom-theme-input">
                    <input type="text" id="customThemeName" placeholder="ä¾‹å¦‚ï¼šå›¾ä¹¦é¦†ã€åšç‰©é¦†ã€é¤å…ç­‰" maxlength="30">
                </div>
                <button id="confirmCustomTheme" class="btn btn-primary">
                    ç¡®è®¤ä¸»é¢˜
                </button>
            `;

            document.getElementById('confirmCustomTheme').addEventListener('click', function() {
                customThemeName = document.getElementById('customThemeName').value.trim();
                if (customThemeName) {
                    selectedTheme = 'custom';
                    showSceneSelection('custom');
                } else {
                    alert('è¯·è¾“å…¥ä¸»é¢˜åç§°');
                }
            });

            // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
            document.getElementById('customThemeName').focus();
        }

        // æ˜¾ç¤ºåœºæ™¯é€‰æ‹©
        function showSceneSelection(theme) {
            themeSelector.style.display = 'none';
            sceneSelector.style.display = 'block';

            // è·å–åœºæ™¯æ•°æ®
            let scenes = sceneData[theme] || [];

            // å¦‚æœæ˜¯è‡ªå®šä¹‰ä¸»é¢˜ï¼Œæä¾›é€šç”¨åœºæ™¯æ¨¡æ¿
            if (theme === 'custom' || scenes.length === 0) {
                scenes = [
                    { name: `${customThemeName || 'ä¸»é¢˜'}æ¢é™©è®°`, icon: 'ğŸ—ºï¸', desc: 'æ¢ç´¢ä¸»é¢˜çš„å¥¥ç§˜' },
                    { name: `${customThemeName || 'ä¸»é¢˜'}çš„ä¸€å¤©`, icon: 'ğŸ“…', desc: 'ä½“éªŒä¸»é¢˜çš„æ—¥å¸¸ç”Ÿæ´»' },
                    { name: `ç¥å¥‡çš„${customThemeName || 'ä¸»é¢˜'}`, icon: 'âœ¨', desc: 'å‘ç°ä¸»é¢˜çš„ç¥å¥‡ä¹‹å¤„' },
                    { name: `${customThemeName || 'ä¸»é¢˜'}å°çŸ¥è¯†`, icon: 'ğŸ’¡', desc: 'å­¦ä¹ ä¸»é¢˜ç›¸å…³çŸ¥è¯†' },
                    { name: `æˆ‘çˆ±${customThemeName || 'ä¸»é¢˜'}`, icon: 'â¤ï¸', desc: 'è¡¨è¾¾å¯¹ä¸»é¢˜çš„å–œçˆ±' },
                    { name: `${customThemeName || 'ä¸»é¢˜'}å®‰å…¨å®ˆåˆ™`, icon: 'âš ï¸', desc: 'äº†è§£ä¸»é¢˜ç›¸å…³çš„å®‰å…¨çŸ¥è¯†' }
                ];
            }

            // ç”Ÿæˆåœºæ™¯å¡ç‰‡
            sceneGrid.innerHTML = scenes.map((scene, index) => `
                <div class="scene-card ${index === 0 ? 'selected' : ''}" data-scene="${scene.name}">
                    <div class="scene-icon">${scene.icon}</div>
                    <div class="scene-name">${scene.name}</div>
                </div>
            `).join('');

            // æ·»åŠ åœºæ™¯é€‰æ‹©äº‹ä»¶
            document.querySelectorAll('.scene-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('.scene-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedScene = this.dataset.scene;
                    startGenerationBtn.disabled = false;
                });
            });

            // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªåœºæ™¯
            if (scenes.length > 0) {
                selectedScene = scenes[0].name;
                startGenerationBtn.disabled = false;
            }

            // æ˜¾ç¤ºè‡ªå®šä¹‰åœºæ™¯è¾“å…¥
            document.getElementById('customSceneContainer').style.display = 'block';

            // è‡ªå®šä¹‰åœºæ™¯è¾“å…¥äº‹ä»¶
            document.getElementById('customSceneInput').addEventListener('input', function() {
                if (this.value.trim()) {
                    customSceneName = this.value.trim();
                    document.querySelectorAll('.scene-card').forEach(c => c.classList.remove('selected'));
                    selectedScene = customSceneName;
                    startGenerationBtn.disabled = false;
                }
            });

            // å›é€€æŒ‰é’®äº‹ä»¶
            document.getElementById('backToThemeBtn').addEventListener('click', function() {
                // é‡ç½®é€‰æ‹©çŠ¶æ€
                selectedScene = null;
                customSceneName = null;
                document.getElementById('customSceneInput').value = '';

                // è¿”å›ä¸»é¢˜é€‰æ‹©
                sceneSelector.style.display = 'none';
                themeSelector.style.display = 'block';

                // é‡ç½®ä¸»é¢˜é€‰æ‹©çŠ¶æ€
                document.querySelectorAll('.theme-card').forEach(card => {
                    card.classList.remove('selected');
                });
                selectedTheme = null;
            });

            // å¼€å§‹ç”ŸæˆæŒ‰é’®äº‹ä»¶
            startGenerationBtn.addEventListener('click', startGeneration);
        }

        // æ·»åŠ æ¶ˆæ¯
        function addMessage(content, type = 'system') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;

            messageDiv.appendChild(contentDiv);
            dialogBox.appendChild(messageDiv);
            dialogBox.scrollTop = dialogBox.scrollHeight;
        }

        // è·å–ä¸»é¢˜åç§°
        function getThemeName(theme) {
            const names = {
                'supermarket': 'è¶…å¸‚',
                'hospital': 'åŒ»é™¢',
                'park': 'å…¬å›­',
                'school': 'å­¦æ ¡',
                'zoo': 'åŠ¨ç‰©å›­',
                'traffic': 'äº¤é€š',
                'home': 'å®¶åº­',
                'farm': 'å†œåœº'
            };
            return names[theme] || 'ä¸»é¢˜';
        }

        // ç”Ÿæˆè¯¦ç»†çš„Prompt
        function generateDetailedPrompt(theme, scene) {
            const themeName = theme === 'custom' ? customThemeName : getThemeName(theme);

            // æ ¹æ®ä¸»é¢˜ç”Ÿæˆè¯¦ç»†çš„è¯æ±‡åˆ—è¡¨
            const vocabularies = generateThemeVocabularies(theme);

            // å»é‡è¯æ±‡åˆ—è¡¨ï¼ˆé¿å…é‡å¤ï¼‰
            const uniqueVocabularies = [];
            const seen = new Set();
            vocabularies.forEach(v => {
                if (!seen.has(v.chinese)) {
                    seen.add(v.chinese);
                    uniqueVocabularies.push(v);
                }
            });

            // æ„å»ºå®Œæ•´çš„ã€ç»“æ„åŒ–çš„prompt
            return `è¯·ç”Ÿæˆä¸€å¼ å„¿ç«¥è¯†å­—æ•™å­¦å°æŠ¥ï¼Œä¸»é¢˜æ˜¯"${themeName}"ï¼Œåœºæ™¯æ˜¯"${scene}"ã€‚

## æ ¸å¿ƒè¦æ±‚ï¼š
è¿™æ˜¯ä¸€å¼ é¢å‘5-9å²å„¿ç«¥çš„ä¸­æ–‡è¯†å­—æ•™å­¦å›¾ç‰‡ï¼Œé‡‡ç”¨"ä¸»ç”»é¢+åº•éƒ¨è¯è¯­å¡ç‰‡"çš„åˆ†ç¦»å¼å¸ƒå±€ã€‚

## è¯è¯­æ¥æºè§„åˆ™ï¼ˆCRITICAL - å¿…é¡»éµå®ˆï¼‰ï¼š
**åº•éƒ¨è¯è¯­å¡ç‰‡ä¸­çš„è¯è¯­å¿…é¡»ä¸¥æ ¼æœä»ä¸»é¢˜å’Œåœºæ™¯ï¼š**
1. æ‰€æœ‰è¯è¯­å¿…é¡»æ˜¯"${themeName}"ä¸»é¢˜ä¸‹ã€"${scene}"åœºæ™¯ä¸­"å¯è¢«çœ‹è§ã€å¯è¢«æŒ‡è®¤çš„å…·ä½“äº‹ç‰©"
2. ä¸¥æ ¼ç¦æ­¢ä½¿ç”¨æŠ½è±¡æ¦‚å¿µè¯ï¼ˆå¦‚ï¼šå­¦ä¹ ã€å¿«ä¹ã€æˆé•¿ã€æ¢ç´¢ã€å‘ç°ã€ä¸–ç•Œç­‰ï¼‰
3. ä¸¥æ ¼ç¦æ­¢ä½¿ç”¨æƒ…ç»ª/å“æ ¼/ä»·å€¼è§‚ç±»è¯è¯­ï¼ˆå¦‚ï¼šå‹‡æ•¢ã€å‹è°Šã€çˆ±å¿ƒã€å¸®åŠ©ç­‰ï¼‰
4. ä¸¥æ ¼ç¦æ­¢ä½¿ç”¨é€šç”¨å„¿ç«¥æ•™è‚²å…œåº•è¯
5. å¦‚æœä¸»é¢˜æ˜¯"å¤§è‡ªç„¶"ã€"æ£®æ—"ç­‰è‡ªç„¶åœºæ™¯ï¼Œåªèƒ½ä½¿ç”¨ï¼šæ ‘æœ¨ã€æ²³æµã€å±±ã€èŠ±æœµã€åŠ¨ç‰©ç­‰å…·ä½“å¯è§ç‰©ä½“
6. å¦‚æœä¸»é¢˜æ˜¯"å¤ªç©º"ï¼Œåªèƒ½ä½¿ç”¨ï¼šæ˜Ÿæ˜Ÿã€æœˆäº®ã€ç«ç®­ã€å®‡èˆªå‘˜ç­‰å…·ä½“å¯è§ç‰©ä½“
7. å¦‚æœä¸»é¢˜æ˜¯"æµ·æ´‹"ï¼Œåªèƒ½ä½¿ç”¨ï¼šæµ·æ°´ã€æ³¢æµªã€é±¼ã€çŠç‘šç­‰å…·ä½“å¯è§ç‰©ä½“
8. **å®å¯å°‘ç”Ÿæˆè¯è¯­ï¼Œä¹Ÿä¸è¦ä½¿ç”¨ä¸åœºæ™¯æ— å…³çš„æŠ½è±¡è¯**

## å¸ƒå±€ç»“æ„ï¼ˆç«–ç‰ˆA4æ¯”ä¾‹ï¼Œ3:4ï¼‰ï¼š

### ç¬¬ä¸€éƒ¨åˆ†ï¼šé¡¶éƒ¨æ ‡é¢˜åŒºï¼ˆå æ•´ä½“15%ï¼‰
- å¤§æ ‡é¢˜ï¼š"${scene}"ï¼ˆé†’ç›®ã€å½©è‰²ã€å„¿ç«¥æ‰‹å†™ä½“é£æ ¼ï¼‰
- å‰¯æ ‡é¢˜ï¼š"å„¿ç«¥è¯†å­—å°æŠ¥"æˆ–"${themeName}è®¤çŸ¥å­¦ä¹ "
- è£…é¥°ï¼šä¸»é¢˜ç›¸å…³çš„å¡é€šå…ƒç´ 

### ç¬¬äºŒéƒ¨åˆ†ï¼šä¸»åœºæ™¯æ’ç”»åŒºï¼ˆå æ•´ä½“60%ï¼‰
**CRITICAL - ä¸»ç”»é¢å¿…é¡»å®Œå…¨å¹²å‡€ï¼Œåªå±•ç¤ºåœºæ™¯æ’ç”»ï¼š**

#### ä¸»ç”»é¢å†…å®¹è¦æ±‚ï¼š
- ${themeName}ä¸»é¢˜ä¸‹çš„"${scene}"å…·ä½“åœºæ™¯
- å®Œæ•´çš„åœºæ™¯æ’ç”»ï¼ŒåŒ…å«ç¯å¢ƒèƒŒæ™¯
- ç”»é¢è¦å……å®ï¼Œä¸è¦ç•™ç™½è¿‡å¤š
- å¿…é¡»åŒ…å«8-10ä¸ªä¸ä¸»é¢˜ç›¸å…³çš„å…·ä½“ç‰©å“/å…ƒç´ 
- é«˜é¥±å’Œåº¦ã€æ˜äº®æ¸©æš–çš„è‰²å½©
- å„¿ç«¥ç»˜æœ¬é£æ ¼

#### ä¸»ç”»é¢ä¸¥æ ¼ç¦æ­¢äº‹é¡¹ï¼ˆå¿…é¡»100%éµå®ˆï¼‰ï¼š
1. **ç»å¯¹ç¦æ­¢åœ¨ä¸»ç”»é¢ä¸­å‡ºç°ä»»ä½•æ±‰å­—**
2. **ç»å¯¹ç¦æ­¢åœ¨ä¸»ç”»é¢ä¸­å‡ºç°ä»»ä½•æ‹¼éŸ³**
3. **ç»å¯¹ç¦æ­¢åœ¨ä¸»ç”»é¢ä¸­å‡ºç°ä»»ä½•æ ‡ç­¾æ¡†ã€è´´çº¸**
4. **ç»å¯¹ç¦æ­¢åœ¨ä¸»ç”»é¢ä¸­å‡ºç°ä»»ä½•è¿çº¿ã€ç®­å¤´ã€æŒ‡å¼•çº¿**
5. **ç»å¯¹ç¦æ­¢åœ¨ä¸»ç”»é¢ä¸­å‡ºç°ä»»ä½•æ•°å­—ã€ç™¾åˆ†æ¯”ã€åˆ†æ•°ï¼ˆå¦‚60%ã€20%ã€0.6ï¼‰**
6. **ç»å¯¹ç¦æ­¢åœ¨ä¸»ç”»é¢ä¸­å‡ºç°ä»»ä½•è°ƒè¯•ä¿¡æ¯ã€ç½®ä¿¡åº¦åˆ†æ•°**
7. **ç»å¯¹ç¦æ­¢åœ¨ä¸»ç”»é¢ä¸­å‡ºç°bounding boxè¾¹æ¡†ã€æ–¹æ¡†**
8. **ç»å¯¹ç¦æ­¢åœ¨ä¸»ç”»é¢ä¸­å‡ºç°ä»»ä½•æ•°å­—ç¼–å·ï¼ˆå¦‚â‘ â‘¡â‘¢ã€1.2.3ï¼‰**
9. **ç»å¯¹ç¦æ­¢åœ¨ä¸»ç”»é¢ä¸­å‡ºç°ä»»ä½•è‹±æ–‡å•è¯**
10. **ç»å¯¹ç¦æ­¢åœ¨ä¸»ç”»é¢ä¸­å‡ºç°ä»»ä½•æ§åˆ¶æŒ‡ä»¤æ–‡æœ¬ï¼ˆå¦‚"PURE ILLUSTRATION ONLY"ã€"ILLUSTRATION"ã€"MODE"ã€"LAYOUT"ç­‰ï¼‰**
11. **ç»å¯¹ç¦æ­¢åœ¨ä¸»ç”»é¢ä¸­å‡ºç°ä»»ä½•ä¸­é—´çŠ¶æ€æè¿°ï¼ˆå¦‚"60% - xxx"ã€"percentage"ã€"score"ç­‰ï¼‰**
12. **ç»å¯¹ç¦æ­¢åœ¨ä¸»ç”»é¢ä¸­å‡ºç°ä»»ä½•promptæ³„éœ²ã€æ¨¡æ¿æ³„éœ²ã€ç³»ç»ŸæŒ‡ä»¤æ³„éœ²**

#### ä¸»ç”»é¢åªå…è®¸åŒ…å«ï¼š
- åœºæ™¯æ’ç”»ï¼ˆäººç‰©ã€åŠ¨ç‰©ã€ç‰©å“ã€èƒŒæ™¯ï¼‰
- è£…é¥°å›¾æ¡ˆ
- **ä¸»ç”»é¢å¿…é¡»æ˜¯çº¯å›¾ç‰‡ï¼Œä¸èƒ½æœ‰ä»»ä½•æ–‡å­—å…ƒç´ **

### ç¬¬ä¸‰éƒ¨åˆ†ï¼šåº•éƒ¨è¯è¯­å¡ç‰‡åŒºï¼ˆå æ•´ä½“25%ï¼‰
**æ‰€æœ‰è¯†å­—è¯è¯­ç»Ÿä¸€æ”¾åœ¨ç”»é¢æœ€åº•éƒ¨ï¼Œä»¥"è¯è¯­å¡ç‰‡"å½¢å¼å±•ç¤ºï¼š**

#### è¯è¯­å¡ç‰‡å¸ƒå±€ï¼š
- å°†åº•éƒ¨åŒºåŸŸæ¨ªå‘åˆ†æˆå¤šä¸ªå°å¡ç‰‡æ ¼å­
- æ¯ä¸ªå¡ç‰‡åŒ…å«ï¼š**å°å›¾æ ‡ + æ±‰å­— + æ‹¼éŸ³**
- å¡ç‰‡æ’åˆ—ï¼šä»å·¦åˆ°å³ï¼Œ2-3è¡Œæ’åˆ—
- å¡ç‰‡æ ·å¼ï¼šå½©è‰²è¾¹æ¡†ï¼Œæµ…è‰²èƒŒæ™¯ï¼Œæ¸…æ™°æ˜“è¯»

#### æ¯ä¸ªè¯è¯­å¡ç‰‡å¿…é¡»åŒ…å«ï¼š
1. **ä¸Šæ–¹ï¼šå°å›¾æ ‡/å°æ’ç”»**
   - ç”»å‡ºå¯¹åº”ç‰©å“çš„ç®€åŒ–å›¾æ ‡
   - ä¾‹å¦‚ï¼š"é»‘æ¿"å¡ç‰‡çš„å°å›¾æ ‡æ˜¯ä¸€ä¸ªå°é»‘æ¿æ ·å¼
   - ä¾‹å¦‚ï¼š"åŒ»ç”Ÿ"å¡ç‰‡çš„å°å›¾æ ‡æ˜¯ä¸€ä¸ªç©¿ç™½å¤§è¤‚çš„å°äºº
   - åªè¦æ±‚**è¯­ä¹‰ä¸€è‡´**ï¼ˆçœ‹èµ·æ¥åƒé‚£ä¸ªä¸œè¥¿ï¼‰
   - **ä¸è¦æ±‚**ä¸ä¸»ç”»é¢ä¸­æŸä¸ªå…·ä½“å®ä¾‹ä¸€ä¸€å¯¹åº”

2. **ä¸‹æ–¹ï¼šæ–‡å­—**
   - ç¬¬ä¸€è¡Œï¼šæ‹¼éŸ³ï¼ˆå¸¦å£°è°ƒï¼‰
   - ç¬¬äºŒè¡Œï¼šæ±‰å­—
   - å­—ä½“ï¼šæ¸…æ™°ã€è§„èŒƒã€å¤§å°é€‚ä¸­

#### å¿…é¡»å±•ç¤ºçš„è¯è¯­å¡ç‰‡æ¸…å•ï¼ˆå…±${uniqueVocabularies.length}ä¸ªï¼‰ï¼š
${uniqueVocabularies.map((v, i) => `${i + 1}. ${v.chinese}ï¼ˆ${v.pinyin}ï¼‰`).join('\n')}

**æ³¨æ„ï¼šä»¥ä¸Šæ¯ä¸ªè¯è¯­å¿…é¡»ç”Ÿæˆä¸€ä¸ªç‹¬ç«‹çš„å¡ç‰‡ï¼Œæ¯ä¸ªè¯è¯­åªå‡ºç°ä¸€æ¬¡ï¼Œä¸èƒ½é‡å¤ã€‚**

#### è¯è¯­å¡ç‰‡è®¾è®¡ç¤ºä¾‹ï¼š
æ¯ä¸ªè¯è¯­å¡ç‰‡æ ¼å¼å¦‚ä¸‹ï¼š
[æ–¹æ¡†å†…ï¼šå°é»‘æ¿å›¾æ ‡]
ä¸‹æ–¹ï¼šhÄ“i bÇn
å†ä¸‹æ–¹ï¼šé»‘æ¿

## é‡ç‚¹å¼ºè°ƒï¼ˆå¼ºçº¦æŸï¼‰ï¼š
1. **ä¸»ç”»é¢å’Œåº•éƒ¨è¯è¯­åŒºå®Œå…¨åˆ†ç¦»**
2. **ä¸»ç”»é¢ä¸­ç»å¯¹ä¸èƒ½æœ‰ä»»ä½•æ–‡å­—ã€æ‹¼éŸ³ã€æ ‡ç­¾ã€è¿çº¿**
3. **æ‰€æœ‰è¯†å­—å†…å®¹åªåœ¨åº•éƒ¨å¡ç‰‡åŒºåŸŸå±•ç¤º**
4. **åº•éƒ¨å¡ç‰‡ä¸­çš„å°å›¾æ ‡åªè¦æ±‚è¯­ä¹‰ä¸€è‡´ï¼Œä¸éœ€è¦ä¸ä¸»ç”»é¢ä¸­çš„å…·ä½“å¯¹è±¡å¯¹åº”**
5. **æ¯ä¸ªè¯è¯­åªå‡ºç°ä¸€æ¬¡ï¼Œä¸èƒ½é‡å¤**
6. **åº•éƒ¨å¡ç‰‡æ’åˆ—æ•´é½ï¼Œé€‚åˆå„¿ç«¥é˜…è¯»å­¦ä¹ **

## é£æ ¼è¯´æ˜ï¼š
- ä½¿ç”¨æ¸©æš–çš„è‰²è°ƒï¼Œä»¥ç»¿è‰²ã€è“è‰²ã€æ©™è‰²ä¸ºä¸»
- è§’è‰²è®¾è®¡è¦å¯çˆ±ã€å‹å¥½
- çº¿æ¡æ¸…æ™°ï¼Œé€‚åˆå„¿ç«¥è®¤çŸ¥
- 8Kåˆ†è¾¨ç‡ï¼Œç¡®ä¿æ–‡å­—æ¸…æ™°å¯è¯»

## æœ€ç»ˆè‡ªæ£€æ¸…å•ï¼ˆç”Ÿæˆå‰å¿…é¡»ç¡®è®¤ï¼‰ï¼š
- [ ] ä¸»ç”»é¢ä¸­æ²¡æœ‰æ±‰å­—ã€æ‹¼éŸ³ã€æ ‡ç­¾
- [ ] ä¸»ç”»é¢ä¸­æ²¡æœ‰è¿çº¿ã€ç®­å¤´ã€æ–¹æ¡†
- [ ] ä¸»ç”»é¢ä¸­æ²¡æœ‰æ•°å­—ã€ç™¾åˆ†æ¯”ã€è°ƒè¯•ä¿¡æ¯
- [ ] ä¸»ç”»é¢æ˜¯çº¯åœºæ™¯æ’ç”»
- [ ] æ‰€æœ‰è¯è¯­éƒ½åœ¨åº•éƒ¨å¡ç‰‡åŒºåŸŸ
- [ ] æ¯ä¸ªè¯è¯­å¡ç‰‡éƒ½æœ‰å¯¹åº”çš„å°å›¾æ ‡
- [ ] è¯è¯­æ²¡æœ‰é‡å¤ï¼Œæ¯ä¸ªåªå‡ºç°ä¸€æ¬¡
- [ ] æ•´ä½“é€‚åˆ5-9å²å„¿ç«¥é˜…è¯»å­¦ä¹ 

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸Šå¸ƒå±€å’Œè¦æ±‚ç”Ÿæˆå›¾ç‰‡ã€‚`;
        }

        // ç”Ÿæˆä¸»é¢˜è¯æ±‡
        function generateThemeVocabularies(theme) {
            const vocabMap = {
                'supermarket': [
                    { chinese: 'æ”¶é“¶å°', pinyin: 'shÅu yÃ­n tÃ¡i' },
                    { chinese: 'è´­ç‰©è½¦', pinyin: 'gÃ²u wÃ¹ chÄ“' },
                    { chinese: 'è´§æ¶', pinyin: 'huÃ² jiÃ ' },
                    { chinese: 'æ”¶é“¶å‘˜', pinyin: 'shÅu yÃ­n yuÃ¡n' },
                    { chinese: 'è‹¹æœ', pinyin: 'pÃ­ng guÇ’' },
                    { chinese: 'ç‰›å¥¶', pinyin: 'niÃº nÇi' },
                    { chinese: 'é¢åŒ…', pinyin: 'miÃ n bÄo' },
                    { chinese: 'ä»·æ ¼æ ‡ç­¾', pinyin: 'jiÃ  gÃ© biÄo qiÄn' },
                    { chinese: 'è´­ç‰©è¢‹', pinyin: 'gÃ²u wÃ¹ dÃ i' },
                    { chinese: 'ç§°é‡å™¨', pinyin: 'chÄ“ng zhÃ²ng qÃ¬' }
                ],
                'hospital': [
                    { chinese: 'åŒ»ç”Ÿ', pinyin: 'yÄ« shÄ“ng' },
                    { chinese: 'æŠ¤å£«', pinyin: 'hÃ¹ shi' },
                    { chinese: 'å¬è¯Šå™¨', pinyin: 'tÄ«ng zhÄ›n qÃ¬' },
                    { chinese: 'ä½“æ¸©è®¡', pinyin: 'tÇ wÄ“n jÃ¬' },
                    { chinese: 'ç—…åºŠ', pinyin: 'bÃ¬ng chuÃ¡ng' },
                    { chinese: 'è¯ç®±', pinyin: 'yÃ o xiÄng' },
                    { chinese: 'æ³¨å°„å™¨', pinyin: 'zhÃ¹ shÃ¨ qÃ¬' },
                    { chinese: 'è¡€å‹è®¡', pinyin: 'xuÃ¨ yÄ jÃ¬' },
                    { chinese: 'æŒ‚å·å°', pinyin: 'guÃ  hÃ o tÃ¡i' },
                    { chinese: 'ç—…å†æœ¬', pinyin: 'bÃ¬ng lÃ¬ bÄ›n' }
                ],
                'park': [
                    { chinese: 'æ»‘æ¢¯', pinyin: 'huÃ¡ tÄ«' },
                    { chinese: 'ç§‹åƒ', pinyin: 'qiÅ« qiÄn' },
                    { chinese: 'è··è··æ¿', pinyin: 'qiÄo qiÄo bÇn' },
                    { chinese: 'é•¿æ¤…', pinyin: 'chÃ¡ng yÇ' },
                    { chinese: 'èŠ±æœµ', pinyin: 'huÄ duÇ’' },
                    { chinese: 'æ ‘æœ¨', pinyin: 'shÃ¹ mÃ¹' },
                    { chinese: 'è‰åª', pinyin: 'cÇo pÃ­ng' },
                    { chinese: 'å°è·¯', pinyin: 'xiÇo lÃ¹' },
                    { chinese: 'å¥èº«å™¨æ', pinyin: 'jiÃ n shÄ“n qÃ¬ cÃ¡i' },
                    { chinese: 'å–·æ³‰', pinyin: 'pÄ“n quÃ¡n' }
                ],
                'school': [
                    { chinese: 'é»‘æ¿', pinyin: 'hÄ“i bÇn' },
                    { chinese: 'è¯¾æ¡Œ', pinyin: 'kÃ¨ zhuÅ' },
                    { chinese: 'è¯¾æœ¬', pinyin: 'kÃ¨ bÄ›n' },
                    { chinese: 'é“…ç¬”', pinyin: 'qiÄn bÇ' },
                    { chinese: 'ä¹¦åŒ…', pinyin: 'shÅ« bÄo' },
                    { chinese: 'è€å¸ˆ', pinyin: 'lÇo shÄ«' },
                    { chinese: 'å­¦ç”Ÿ', pinyin: 'xuÃ© sheng' },
                    { chinese: 'æ“åœº', pinyin: 'cÄo chÇng' },
                    { chinese: 'å›¾ä¹¦é¦†', pinyin: 'tÃº shÅ« guÇn' },
                    { chinese: 'æ•™å®¤', pinyin: 'jiÃ o shÃ¬' }
                ],
                'zoo': [
                    { chinese: 'ç‹®å­', pinyin: 'shÄ« zi' },
                    { chinese: 'è€è™', pinyin: 'lÇo hÇ”' },
                    { chinese: 'å¤§è±¡', pinyin: 'dÃ  xiÃ ng' },
                    { chinese: 'çŒ´å­', pinyin: 'hÃ³u zi' },
                    { chinese: 'ç†ŠçŒ«', pinyin: 'xiÃ³ng mÄo' },
                    { chinese: 'é•¿é¢ˆé¹¿', pinyin: 'chÃ¡ng jÇng lÃ¹' },
                    { chinese: 'ç¬¼å­', pinyin: 'lÃ³ng zi' },
                    { chinese: 'é¥²å…»å‘˜', pinyin: 'sÃ¬ yÇng yuÃ¡n' },
                    { chinese: 'é£Ÿç‰©', pinyin: 'shÃ­ wÃ¹' },
                    { chinese: 'å›´æ ', pinyin: 'wÃ©i lÃ¡n' }
                ],
                'traffic': [
                    { chinese: 'çº¢ç»¿ç¯', pinyin: 'hÃ³ng lÇœ dÄ“ng' },
                    { chinese: 'æ–‘é©¬çº¿', pinyin: 'bÄn mÇ xiÃ n' },
                    { chinese: 'äº¤é€šè­¦å¯Ÿ', pinyin: 'jiÄo tÅng jÇng chÃ¡' },
                    { chinese: 'äººè¡Œé“', pinyin: 'rÃ©n xÃ­ng dÃ o' },
                    { chinese: 'å…¬äº¤è½¦', pinyin: 'gÅng gÃ²ng qÃ¬ chÄ“' },
                    { chinese: 'è‡ªè¡Œè½¦', pinyin: 'zÃ¬ xÃ­ng chÄ“' },
                    { chinese: 'å‡ºç§Ÿè½¦', pinyin: 'chÅ« zÅ« chÄ“' },
                    { chinese: 'åœ°é“', pinyin: 'dÃ¬ tiÄ›' },
                    { chinese: 'äº¤é€šæ ‡å¿—', pinyin: 'jiÄo tÅng biÄo zhÃ¬' },
                    { chinese: 'å®‰å…¨å¸¦', pinyin: 'Än quÃ¡n dÃ i' }
                ],
                'home': [
                    { chinese: 'æ²™å‘', pinyin: 'shÄ fÄ' },
                    { chinese: 'ç”µè§†æœº', pinyin: 'diÃ n shÃ¬ jÄ«' },
                    { chinese: 'é¤æ¡Œ', pinyin: 'cÄn zhuÅ' },
                    { chinese: 'å¨æˆ¿', pinyin: 'chÃº fÃ¡ng' },
                    { chinese: 'å†°ç®±', pinyin: 'bÄ«ng xiÄng' },
                    { chinese: 'æ´—è¡£æœº', pinyin: 'xÇ yÄ« jÄ«' },
                    { chinese: 'åºŠ', pinyin: 'chuÃ¡ng' },
                    { chinese: 'ä¹¦æ¡Œ', pinyin: 'shÅ« zhuÅ' },
                    { chinese: 'è¡£æŸœ', pinyin: 'yÄ« guÃ¬' },
                    { chinese: 'å…¨å®¶ç¦', pinyin: 'quÃ¡n jiÄ fÃº' }
                ],
                'farm': [
                    { chinese: 'æ‹–æ‹‰æœº', pinyin: 'tuÅ lÄ jÄ«' },
                    { chinese: 'æ°´ç¨»', pinyin: 'shuÇ dÃ o' },
                    { chinese: 'å°éº¦', pinyin: 'xiÇo mÃ i' },
                    { chinese: 'ç‰ç±³', pinyin: 'yÃ¹ mÇ' },
                    { chinese: 'å†œèˆ', pinyin: 'nÃ³ng shÃ¨' },
                    { chinese: 'è°·ä»“', pinyin: 'gÇ” cÄng' },
                    { chinese: 'æ°´äº•', pinyin: 'shuÇ jÇng' },
                    { chinese: 'çŠ', pinyin: 'lÃ­' },
                    { chinese: 'é•°åˆ€', pinyin: 'liÃ¡n dÄo' },
                    { chinese: 'ä¸°æ”¶', pinyin: 'fÄ“ng shÅu' }
                ]
            };

            // å¯¹äºè‡ªå®šä¹‰ä¸»é¢˜ï¼ŒåŸºäºä¸»é¢˜å’Œåœºæ™¯æ™ºèƒ½ç”Ÿæˆå¯è§ç‰©ä½“è¯æ±‡
            if (!vocabMap[theme]) {
                return this.generateSceneBasedVocabularies(theme, customSceneName || '');
            }

            return vocabMap[theme];
        }

        // åŸºäºåœºæ™¯æ™ºèƒ½ç”Ÿæˆå¯è§ç‰©ä½“è¯æ±‡ï¼ˆåªç”Ÿæˆå…·ä½“å¯è§ç‰©ä½“ï¼Œç¦æ­¢æŠ½è±¡æ¦‚å¿µï¼‰
        function generateSceneBasedVocabularies(theme, scene) {
            const themeName = customThemeName || theme;
            const sceneName = scene || '';

            // åŸºäºä¸»é¢˜å’Œåœºæ™¯å…³é”®è¯ï¼Œæ™ºèƒ½ç”Ÿæˆè¯¥åœºæ™¯ä¸­"å¯è¢«çœ‹è§ã€å¯è¢«æŒ‡è®¤"çš„å…·ä½“ç‰©ä½“è¯æ±‡
            // ä¸¥æ ¼ç¦æ­¢ï¼šæŠ½è±¡æ¦‚å¿µã€æƒ…ç»ªè¯ã€ä»·å€¼è§‚è¯ã€é€šç”¨æ•™è‚²è¯
            const sceneVocabMap = {
                // è‡ªç„¶åœºæ™¯ç±»
                'å¤§è‡ªç„¶': [
                    { chinese: 'æ ‘æœ¨', pinyin: 'shÃ¹ mÃ¹' },
                    { chinese: 'æ²³æµ', pinyin: 'hÃ© liÃº' },
                    { chinese: 'å±±', pinyin: 'shÄn' },
                    { chinese: 'ç€‘å¸ƒ', pinyin: 'pÃ¹ bÃ¹' },
                    { chinese: 'èŠ±æœµ', pinyin: 'huÄ duÇ’' },
                    { chinese: 'è‰åœ°', pinyin: 'cÇo dÃ¬' },
                    { chinese: 'é¹¿', pinyin: 'lÃ¹' },
                    { chinese: 'å…”å­', pinyin: 'tÃ¹ zi' },
                    { chinese: 'é¸Ÿ', pinyin: 'niÇo' },
                    { chinese: 'å¤ªé˜³', pinyin: 'tÃ i yÃ¡ng' }
                ],
                'æ£®æ—': [
                    { chinese: 'å¤§æ ‘', pinyin: 'dÃ  shÃ¹' },
                    { chinese: 'çŒæœ¨', pinyin: 'guÃ n mÃ¹' },
                    { chinese: 'è˜‘è‡', pinyin: 'mÃ³ gu' },
                    { chinese: 'æ¾é¼ ', pinyin: 'sÅng shÇ”' },
                    { chinese: 'ç‹ç‹¸', pinyin: 'hÃº li' },
                    { chinese: 'é‡çŒª', pinyin: 'yÄ› zhÅ«' },
                    { chinese: 'æ ‘å¶', pinyin: 'shÃ¹ yÃ¨' },
                    { chinese: 'æ ‘å¹²', pinyin: 'shÃ¹ gÃ n' },
                    { chinese: 'å°å¾„', pinyin: 'xiÇo jÃ¬ng' },
                    { chinese: 'é˜³å…‰', pinyin: 'yÃ¡ng guÄng' }
                ],
                'æµ·æ´‹': [
                    { chinese: 'æµ·æ°´', pinyin: 'hÇi shuÇ' },
                    { chinese: 'æ³¢æµª', pinyin: 'bÅ lÃ ng' },
                    { chinese: 'æ²™æ»©', pinyin: 'shÄ tÄn' },
                    { chinese: 'è´å£³', pinyin: 'bÃ¨i kÃ©' },
                    { chinese: 'æµ·æ˜Ÿ', pinyin: 'hÇi xÄ«ng' },
                    { chinese: 'èƒèŸ¹', pinyin: 'pÃ¡ng xiÃ¨' },
                    { chinese: 'é±¼', pinyin: 'yÃº' },
                    { chinese: 'æµ·é¾Ÿ', pinyin: 'hÇi guÄ«' },
                    { chinese: 'çŠç‘š', pinyin: 'shÄn hÃº' },
                    { chinese: 'èˆ¹åª', pinyin: 'chuÃ¡n zhÄ«' }
                ],
                'å¤ªç©º': [
                    { chinese: 'æ˜Ÿæ˜Ÿ', pinyin: 'xÄ«ng xing' },
                    { chinese: 'æœˆäº®', pinyin: 'yuÃ¨ liang' },
                    { chinese: 'åœ°çƒ', pinyin: 'dÃ¬ qiÃº' },
                    { chinese: 'ç«ç®­', pinyin: 'huÇ’ jiÃ n' },
                    { chinese: 'å®‡èˆªå‘˜', pinyin: 'yÇ” hÃ¡ng yuÃ¡n' },
                    { chinese: 'å«æ˜Ÿ', pinyin: 'wÃ¨i xÄ«ng' },
                    { chinese: 'é£èˆ¹', pinyin: 'fÄ“i chuÃ¡n' },
                    { chinese: 'è¡Œæ˜Ÿ', pinyin: 'xÃ­ng xÄ«ng' },
                    { chinese: 'é“¶æ²³', pinyin: 'yÃ­n hÃ©' },
                    { chinese: 'å¤ªç©ºèˆ±', pinyin: 'tÃ i kÅng cÄng' }
                ],
                'åŸå¸‚': [
                    { chinese: 'é«˜æ¥¼', pinyin: 'gÄo lÃ³u' },
                    { chinese: 'é©¬è·¯', pinyin: 'mÇ lÃ¹' },
                    { chinese: 'æ±½è½¦', pinyin: 'qÃ¬ chÄ“' },
                    { chinese: 'çº¢ç»¿ç¯', pinyin: 'hÃ³ng lÇœ dÄ“ng' },
                    { chinese: 'äººè¡Œé“', pinyin: 'rÃ©n xÃ­ng dÃ o' },
                    { chinese: 'å•†åº—', pinyin: 'shÄng diÃ n' },
                    { chinese: 'è·¯ç¯', pinyin: 'lÃ¹ dÄ“ng' },
                    { chinese: 'å…¬äº¤ç«™', pinyin: 'gÅng jiÄo zhÃ n' },
                    { chinese: 'å¹¿å‘Šç‰Œ', pinyin: 'guÇng gÃ o pÃ¡i' },
                    { chinese: 'æ–‘é©¬çº¿', pinyin: 'bÄn mÇ xiÃ n' }
                ],
                'è¡—é“': [
                    { chinese: 'é“è·¯', pinyin: 'dÃ o lÃ¹' },
                    { chinese: 'äººè¡Œé“', pinyin: 'rÃ©n xÃ­ng dÃ o' },
                    { chinese: 'è·¯ç‰Œ', pinyin: 'lÃ¹ pÃ¡i' },
                    { chinese: 'åƒåœ¾æ¡¶', pinyin: 'lÄ jÄ« tÇ’ng' },
                    { chinese: 'æ¶ˆé˜²æ “', pinyin: 'xiÄo fÃ¡ng shuÄn' },
                    { chinese: 'è‡ªè¡Œè½¦', pinyin: 'zÃ¬ xÃ­ng chÄ“' },
                    { chinese: 'ç”µåŠ¨è½¦', pinyin: 'diÃ n dÃ²ng chÄ“' },
                    { chinese: 'è¡Œäºº', pinyin: 'xÃ­ng rÃ©n' },
                    { chinese: 'è·¯ç¯', pinyin: 'lÃ¹ dÄ“ng' },
                    { chinese: 'æ ‘æœ¨', pinyin: 'shÃ¹ mÃ¹' }
                ]
            };

            // æ£€æŸ¥ä¸»é¢˜åç§°æ˜¯å¦åŒ¹é…
            for (const [key, vocabs] of Object.entries(sceneVocabMap)) {
                if (themeName.includes(key) || sceneName.includes(key)) {
                    return vocabs;
                }
            }

            // å¦‚æœæ²¡æœ‰åŒ¹é…ï¼Œç”Ÿæˆé€šç”¨çš„å¯è§ç‰©ä½“è¯ï¼ˆè€ŒéæŠ½è±¡æ¦‚å¿µï¼‰
            return [
                { chinese: 'ç‰©å“', pinyin: 'wÃ¹ pÇn' },
                { chinese: 'å·¥å…·', pinyin: 'gÅng jÃ¹' },
                { chinese: 'è£…é¥°', pinyin: 'zhuÄng shÃ¬' },
                { chinese: 'èƒŒæ™¯', pinyin: 'bÃ¨i jÇng' },
                { chinese: 'è§’è‰²', pinyin: 'juÃ© sÃ¨' }
            ];
        }

        // å¼€å§‹ç”Ÿæˆ
        async function startGeneration() {
            if (!selectedScene) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªåœºæ™¯');
                return;
            }

            addMessage(`ä¸»é¢˜ï¼š${selectedTheme === 'custom' ? customThemeName : getThemeName(selectedTheme)}`, 'user');
            addMessage(`åœºæ™¯ï¼š${selectedScene}`, 'user');
            addMessage('æ­£åœ¨ç”Ÿæˆå°æŠ¥ï¼Œè¯·ç¨å€™...');

            sceneSelector.style.display = 'none';
            previewSection.style.display = 'block';

            // æ˜¾ç¤ºè¿›åº¦
            const generationProgress = document.getElementById('generationProgress');
            const progressText = document.getElementById('progressText');
            const progressFill = document.querySelector('.progress-fill');
            generationProgress.style.display = 'block';

            try {
                // æ£€æŸ¥API Key
                const storedApiKey = localStorage.getItem('kie_ai_api_key');
                if (!storedApiKey) {
                    throw new Error('è¯·å…ˆé…ç½®API Key');
                }

                const apiKey = atob(storedApiKey);
                console.log('API Keyå·²å‡†å¤‡');

                // ç”Ÿæˆè¯¦ç»†çš„prompt
                const prompt = generateDetailedPrompt(selectedTheme, selectedScene);
                console.log('Prompté•¿åº¦:', prompt.length);

                // æ˜¾ç¤ºåˆ›å»ºä»»åŠ¡è¿›åº¦
                progressText.textContent = 'æ­£åœ¨åˆ›å»ºç”Ÿæˆä»»åŠ¡...';
                progressFill.style.width = '10%';

                // åˆ›å»ºä»»åŠ¡
                const createResponse = await fetch('https://api.kie.ai/api/v1/jobs/createTask', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'nano-banana-pro',
                        input: {
                            prompt: prompt,
                            image_input: [],
                            aspect_ratio: '3:4',
                            resolution: '4K',
                            output_format: 'png'
                        }
                    })
                });

                const createData = await createResponse.json();
                console.log('åˆ›å»ºä»»åŠ¡å“åº”:', createData);

                if (createData.code !== 200) {
                    throw new Error(createData.msg || 'åˆ›å»ºä»»åŠ¡å¤±è´¥');
                }

                const taskId = createData.data.taskId;
                progressText.textContent = 'ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼Œå¼€å§‹ç”Ÿæˆ...';
                progressFill.style.width = '20%';

                // è½®è¯¢ç»“æœ
                await pollTaskResult(taskId, progressText, progressFill);

            } catch (error) {
                console.error('ç”Ÿæˆå¤±è´¥:', error);
                addMessage('âŒ ç”Ÿæˆå¤±è´¥ï¼š' + error.message, 'system');
                generationProgress.style.display = 'none';
            }
        }

        // è½®è¯¢ä»»åŠ¡ç»“æœ
        async function pollTaskResult(taskId, progressText, progressFill) {
            const apiKey = atob(localStorage.getItem('kie_ai_api_key'));
            let attempts = 0;
            const maxAttempts = 30;

            const poll = async () => {
                try {
                    progressText.textContent = `æŸ¥è¯¢ç”ŸæˆçŠ¶æ€... (å°è¯• ${attempts + 1}/${maxAttempts})`;

                    const response = await fetch(`https://api.kie.ai/api/v1/jobs/recordInfo?taskId=${taskId}`, {
                        headers: {
                            'Authorization': `Bearer ${apiKey}`
                        }
                    });

                    const data = await response.json();
                    console.log('ä»»åŠ¡çŠ¶æ€:', data);

                    if (data.code !== 200) {
                        throw new Error(data.msg || 'æŸ¥è¯¢ä»»åŠ¡å¤±è´¥');
                    }

                    const state = data.data.state;
                    attempts++;
                    const progress = Math.min(20 + (attempts / maxAttempts) * 60, 80);
                    progressFill.style.width = progress + '%';

                    if (state === 'success') {
                        progressFill.style.width = '100%';
                        progressText.textContent = 'ç”ŸæˆæˆåŠŸï¼Œå‡†å¤‡æ˜¾ç¤º...';

                        // è§£æç»“æœ
                        const resultJson = JSON.parse(data.data.resultJson);
                        const imageUrl = resultJson.resultUrls[0];

                        if (imageUrl) {
                            setTimeout(() => {
                                showImage(imageUrl);
                            progressFill.style.width = '100%';
                            progressText.textContent = 'æ­£åœ¨åŠ è½½å›¾ç‰‡...';
                            progressFill.style.width = '90%';
                        }, 500);
                        } else {
                            throw new Error('æœªè·å–åˆ°å›¾ç‰‡URL');
                        }
                    } else if (state === 'fail') {
                        throw new Error(data.data.failMsg || 'ä»»åŠ¡æ‰§è¡Œå¤±è´¥');
                    } else {
                        setTimeout(poll, 2000);
                    }
                } catch (error) {
                    console.error('è½®è¯¢å¤±è´¥:', error);
                    addMessage('âŒ ç”Ÿæˆå¤±è´¥ï¼š' + error.message, 'system');
                    generationProgress.style.display = 'none';
                }
            };

            poll();
        }

        // æ˜¾ç¤ºå›¾ç‰‡
        function showImage(imageUrl) {
            console.log('æ˜¾ç¤ºå›¾ç‰‡:', imageUrl);

            const generationProgress = document.getElementById('generationProgress');
            const imageResult = document.getElementById('imageResult');
            const generatedImage = document.getElementById('generatedImage');

            // éšè—è¿›åº¦ï¼Œæ˜¾ç¤ºå›¾ç‰‡
            generationProgress.style.display = 'none';
            imageResult.style.display = 'block';

            // è®¾ç½®å›¾ç‰‡æº
            generatedImage.src = imageUrl;
            generatedImage.alt = selectedScene;

            // ç¡®ä¿å›¾ç‰‡åŠ è½½
            generatedImage.onload = function() {
                console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ');
                addMessage('âœ… å°æŠ¥ç”ŸæˆæˆåŠŸï¼', 'system');

                // æ»šåŠ¨åˆ°å›¾ç‰‡ä½ç½®
                previewSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            };

            generatedImage.onerror = function() {
                console.error('å›¾ç‰‡åŠ è½½å¤±è´¥');
                addMessage('âŒ å›¾ç‰‡åŠ è½½å¤±è´¥', 'system');
            };

            // è®¾ç½®ä¸‹è½½æŒ‰é’®
            document.getElementById('downloadBtn').onclick = function() {
                const themeName = selectedTheme === 'custom' ? customThemeName : getThemeName(selectedTheme);
                const link = document.createElement('a');
                link.download = `å„¿ç«¥è¯†å­—å°æŠ¥_${themeName}_${new Date().getTime()}.png`;
                link.href = imageUrl;
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // è®¾ç½®é‡æ–°ç”ŸæˆæŒ‰é’®
            document.getElementById('regenerateBtn').onclick = function() {
                imageResult.style.display = 'none';
                startGeneration();
            };

            // è®¾ç½®åˆ›å»ºæ–°å°æŠ¥æŒ‰é’®
            document.getElementById('newCreateBtn').onclick = function() {
                location.reload();
            };
        }

        // APIè®¾ç½®
        document.getElementById('settingsBtn').addEventListener('click', () => {
            document.getElementById('settingsModal').style.display = 'flex';
        });

        document.querySelector('.modal-close').addEventListener('click', () => {
            document.getElementById('settingsModal').style.display = 'none';
        });

        document.getElementById('cancelSettingsBtn').addEventListener('click', () => {
            document.getElementById('settingsModal').style.display = 'none';
        });

        document.getElementById('saveSettingsBtn').addEventListener('click', () => {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (apiKey) {
                localStorage.setItem('kie_ai_api_key', btoa(apiKey));
                alert('API Keyå·²ä¿å­˜ï¼');
                document.getElementById('settingsModal').style.display = 'none';
                addMessage('âœ… API Keyé…ç½®æˆåŠŸï¼', 'system');
            } else {
                alert('è¯·è¾“å…¥API Key');
            }
        });

        // é¡µé¢åŠ è½½æ—¶çš„å¤„ç†
        window.addEventListener('load', () => {
            // ä»localStorageè¯»å–å·²ä¿å­˜çš„API Keyï¼ˆå¦‚æœæœ‰ï¼‰
            const storedApiKey = localStorage.getItem('kie_ai_api_key');
            if (storedApiKey) {
                try {
                    const apiKey = atob(storedApiKey);
                    document.getElementById('apiKeyInput').value = apiKey;
                    console.log('å·²åŠ è½½å·²ä¿å­˜çš„API Key');
                } catch (e) {
                    console.log('API Keyè§£ç å¤±è´¥');
                }
            }

            // è®¾ç½®é»˜è®¤åˆ†è¾¨ç‡
            document.getElementById('resolutionSelect').value = '4K';
        });

        // ESCé”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.getElementById('settingsModal').style.display = 'none';
            }
        });

        console.log('çœŸå®APIç‰ˆåº”ç”¨åŠ è½½å®Œæˆ');
    </script>
</body>
</html>